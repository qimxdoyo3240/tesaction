name: Run tesaction bash

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"

permissions:
  contents: read

concurrency:
  group: tesaction-run
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Locate tesaction directory
        id: locate
        shell: bash
        run: |
          set -euo pipefail
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "Top-level listing:"
          ls -la

          # Cari folder bernama persis "tesaction" (case-sensitive) max depth 4
          DIR="$(find . -maxdepth 4 -type d -name 'tesaction' -print -quit)"
          if [ -z "${DIR}" ]; then
            echo "ERROR: folder 'tesaction' tidak ditemukan."
            echo "Daftar folder (depth 2):"
            find . -maxdepth 2 -type d -print
            exit 1
          fi

          echo "Found tesaction at: $DIR"
          echo "dir=$DIR" >> "$GITHUB_OUTPUT"

      - name: Run bash inside tesaction
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ steps.locate.outputs.dir }}"
          echo "Running in: $(pwd)"
          ls -la
          chmod u+x bash
          ./bash --noTest
